<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditel - An√°lisis Normativo Inteligente de Auditor√≠a</title>
    <meta name="description" content="Sistema especializado en an√°lisis normativo autom√°tico para auditor√≠as">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="main-container">
        <!-- Barra lateral mejorada -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>‚öñÔ∏è Auditel</h2>
                <p class="sidebar-subtitle">Asistente Normativo</p>
            </div>
            
            <div class="sidebar-section">
                <h3>üîç Modos de An√°lisis</h3>
                <button class="sidebar-button active" data-mode="normativo">
                    <span class="button-icon">‚öñÔ∏è</span>
                    <span class="button-text">An√°lisis normativo</span>
                </button>
                <button class="sidebar-button" data-mode="sugerencias" onclick="mostrarMensajeDesarrollo()">
                    <span class="button-icon">üìã</span>
                    <span class="button-text">Sugerencias de auditor√≠a</span>
                    <span class="badge">Pr√≥ximamente</span>
                </button>
            </div>

            <div class="sidebar-section">
                <h3>üìä Bases de Datos</h3>
                {% for auditoria, stats in estadisticas.items() %}
                <div class="database-info">
                    <div class="db-header">
                        <span class="db-icon">
                            {% if auditoria == 'Obra P√∫blica' %}üèóÔ∏è
                            {% elif auditoria == 'Financiera' %}üí∞
                            {% else %}üìÅ{% endif %}
                        </span>
                        <span class="db-name">{{ auditoria }}</span>
                    </div>
                    <div class="db-stats">
                        <span class="db-records">{{ stats.registros }} registros</span>
                    </div>
                    <div class="db-desc">{{ stats.descripcion }}</div>
                </div>
                {% endfor %}
            </div>

            <div class="sidebar-footer">
                <div class="system-status">
                    <div class="status-indicator active"></div>
                    <span>Sistema operativo</span>
                </div>
                <div class="version">v2.0.0</div>
            </div>
        </div>

        <!-- √Årea de contenido principal mejorada -->
        <div class="content-area">
            <div class="top-bar">
                <div class="top-bar-left">
                    <h1>üîç Auditel - An√°lisis Normativo Inteligente</h1>
                    <p class="top-bar-subtitle">Sistema especializado en detecci√≥n autom√°tica de normativas aplicables</p>
                </div>
                <div class="top-bar-right">
                    <form action="{{ url_for('clear') }}" method="post" class="clear-form">
                        <button type="submit" class="clear-button" title="Comenzar nueva sesi√≥n">
                            <span class="button-icon">üîÑ</span>
                            Nueva sesi√≥n
                        </button>
                    </form>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-box" id="chat-box">
                    <!-- Disclaimer integrado en el chat -->
                    <div class="disclaimer-message">
                        <p><span class="warning-icon">‚ö†Ô∏è</span> <strong>Importante:</strong> La informaci√≥n mostrada es generada autom√°ticamente y debe ser verificada. No integra normativa interna espec√≠fica, reglas de operaci√≥n y convenios.</p>
                    </div>

                    {% if chat_history %}
                        {% for chat in chat_history %}
                            <div class="chat-message user">
                                <div class="message-header">
                                    <span class="message-avatar">üë§</span>
                                    <span class="message-sender">T√∫</span>
                                    <span class="message-time">{{ chat.timestamp|datetimeformat }}</span>
                                </div>
                                <div class="message-content">{{ chat.question }}</div>
                            </div>
                            <div class="chat-message bot">
                                <div class="message-header">
                                    <span class="message-avatar">üîç</span>
                                    <span class="message-sender">Auditel</span>
                                    <span class="message-time">{{ chat.timestamp|datetimeformat }}</span>
                                </div>
                                <div class="message-content">
                                    {{ chat.answer }}
                                </div>
                                <div class="message-context">
                                    <small>Contexto: {{ chat.auditoria }}{% if chat.ente %} ‚Ä¢ {{ chat.ente }}{% endif %} ‚Ä¢ Normativas: {{ chat.normativas_encontradas }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="welcome-message">
                            <div class="welcome-header">
                                <h3>üí¨ Bienvenido a Auditel v2.0</h3>
                                <p>Tu asistente especializado en an√°lisis normativo inteligente de auditor√≠a</p>
                            </div>
                            <div class="welcome-features">
                                <div class="feature-card">
                                    <div class="feature-icon">‚öñÔ∏è</div>
                                    <div class="feature-text">
                                        <strong>An√°lisis normativo autom√°tico</strong>
                                        <span>Detecci√≥n inteligente de regulaciones aplicables</span>
                                    </div>
                                </div>
                                <div class="feature-card">
                                    <div class="feature-icon">üîç</div>
                                    <div class="feature-text">
                                        <strong>B√∫squeda sem√°ntica avanzada</strong>
                                        <span>Motor de b√∫squeda por similitud conceptual</span>
                                    </div>
                                </div>
                                <div class="feature-card">
                                    <div class="feature-icon">üìã</div>
                                    <div class="feature-text">
                                        <strong>Base de datos normativa</strong>
                                        <span>Actualizada con legislaci√≥n mexicana vigente</span>
                                    </div>
                                </div>
                                <div class="feature-card">
                                    <div class="feature-icon">üéØ</div>
                                    <div class="feature-text">
                                        <strong>Detecci√≥n de patrones</strong>
                                        <span>Identificaci√≥n autom√°tica de temas relevantes</span>
                                    </div>
                                </div>
                            </div>
                            <div class="welcome-stats">
                                <div class="stat">
                                    <strong>{{ estadisticas.values()|sum(attribute='registros') }}</strong>
                                    <span>Normativas indexadas</span>
                                </div>
                                <div class="stat">
                                    <strong>{{ estadisticas|length }}</strong>
                                    <span>Auditor√≠as disponibles</span>
                                </div>
                                <div class="stat">
                                    <strong>v2.0</strong>
                                    <span>Motor mejorado</span>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div class="input-area">
                    <form id="ask-form" action="{{ url_for('ask') }}" method="post" class="ask-form">
                        <div class="input-wrapper">
                            <textarea 
                                name="question" 
                                placeholder="Escribe tu consulta sobre normativas aplicables aqu√≠... Ej: '¬øQu√© normativas aplican para licitaciones de obra p√∫blica?'" 
                                required
                                maxlength="2000"
                                aria-label="Consulta sobre normativas"
                            ></textarea>
                            <button type="submit" class="send-button" aria-label="Enviar consulta">
                                <span class="send-icon">‚û§</span>
                            </button>
                        </div>
                        <div class="input-footer">
                            <div class="ai-indicator">
                                <span class="ai-badge">ü§ñ IA</span>
                                <span>An√°lisis normativo inteligente ‚Ä¢ B√∫squeda sem√°ntica</span>
                            </div>
                            <div class="input-hints">
                                <span class="hint">üí° <strong>Consejos:</strong> S√© espec√≠fico ‚Ä¢ Usa t√©rminos t√©cnicos ‚Ä¢ Incluye contextos</span>
                                <span class="hint">‚å®Ô∏è <strong>Atajos:</strong> Enter para enviar ‚Ä¢ Shift+Enter para nueva l√≠nea</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts mejorados -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <script>
        // Configuraci√≥n global mejorada
        window.auditelConfig = {
            version: '2.0.0',
            maxQuestionLength: 2000,
            supportedAuditorias: {{ auditorias_config|tojson }},
            features: {
                semanticSearch: true,
                patternDetection: true,
                realTimeValidation: true
            }
        };

        function mostrarMensajeDesarrollo() {
            const chatBox = document.getElementById('chat-box');
            const mensaje = document.createElement('div');
            mensaje.className = 'chat-message bot';
            mensaje.innerHTML = `
                <div class="message-header">
                    <span class="message-avatar">üîç</span>
                    <span class="message-sender">Auditel</span>
                    <span class="message-time">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-content">
                    <div class="feature-coming-soon">
                        <p>üöß <strong>Sugerencias de Auditor√≠a - En Desarrollo</strong></p>
                        <p>Esta funcionalidad estar√° disponible en la pr√≥xima actualizaci√≥n.</p>
                        <div class="coming-features">
                            <div class="feature-item">‚Ä¢ Generaci√≥n autom√°tica de programas de auditor√≠a</div>
                            <div class="feature-item">‚Ä¢ Detecci√≥n de riesgos espec√≠ficos</div>
                            <div class="feature-item">‚Ä¢ Recomendaciones de procedimientos</div>
                        </div>
                        <p>Por ahora, puedes usar el <strong>Modo de An√°lisis Normativo</strong> para consultar regulaciones aplicables.</p>
                    </div>
                </div>
            `;
            chatBox.appendChild(mensaje);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Procesar markdown en mensajes existentes despu√©s de cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false,  // ‚úÖ IMPORTANTE: Permitir HTML
                    headerIds: true
                });

                // Procesar markdown en todos los mensajes existentes del historial
                const messageContents = document.querySelectorAll('.message-content');
                messageContents.forEach(element => {
                    if (!element.classList.contains('processed')) {
                        const originalContent = element.innerHTML;
                        try {
                            element.innerHTML = marked.parse(originalContent);
                            element.classList.add('processed');
                        } catch (error) {
                            console.error('Error procesando markdown:', error);
                            element.innerHTML = originalContent;
                        }
                    }
                });
            }

            // Mejorar accesibilidad
            const mainContainer = document.querySelector('.main-container');
            if (mainContainer) {
                mainContainer.setAttribute('role', 'main');
                mainContainer.setAttribute('aria-label', 'Sistema de an√°lisis normativo Auditel');
            }

            console.log('üîç Auditel v2.0 inicializado correctamente');
            console.log('üìä Configuraci√≥n:', window.auditelConfig);
        });
    </script>
</body>
</html>
